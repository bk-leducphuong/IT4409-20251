# GitHub Actions CI/CD Pipeline for Google Cloud VM Deployment
# This workflow builds and deploys the application on push to master

name: Deploy to Google Cloud VM

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_VM_NAME: ${{ secrets.GCP_VM_NAME }}
  GCP_VM_ZONE: ${{ secrets.GCP_VM_ZONE }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Deploy to VM
        run: |
          gcloud compute ssh $GCP_VM_NAME --zone=$GCP_VM_ZONE --command "
            cd ~/apps/your-repo/backend &&
            git pull origin master &&
            docker-compose -f docker-compose.prod.yml build &&
            docker-compose -f docker-compose.prod.yml up -d &&
            docker-compose -f docker-compose.prod.yml ps
          "
      
      - name: Verify deployment
        run: |
          EXTERNAL_IP=$(gcloud compute instances describe $GCP_VM_NAME --zone=$GCP_VM_ZONE --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "Testing deployment at: http://$EXTERNAL_IP/api/home"
          sleep 10
          curl -f http://$EXTERNAL_IP/api/home || exit 1
      
      - name: Notify on success
        if: success()
        run: echo "Deployment successful!"
      
      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed!"

# To use this workflow:
# 1. Create secrets in GitHub repository settings:
#    - GCP_SA_KEY: Service account key JSON
#    - GCP_PROJECT_ID: Your GCP project ID
#    - GCP_VM_NAME: VM instance name
#    - GCP_VM_ZONE: VM zone (e.g., us-central1-a)
# 2. Ensure service account has necessary permissions
# 3. Push to master branch to trigger deployment
